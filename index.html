<!DOCTYPE html>
<html>
  <head>
    <base href="/" />
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"
    />
    <title>IMKit Demo</title>
    <link rel="apple-touch-icon" size="192x192" href="static/favicon-192.png" />
    <link rel="Shortcut Icon" size="32x32" href="static/favicon-32.png" />
    <link rel="manifest" href="static/manifest.json" />
    <link href="static/css/reset.css" rel="stylesheet" />
    <link href="static/css/index.css" rel="stylesheet" />
    <link href="static/css/app.css" rel="stylesheet" />
  </head>

  <body>
    <div id="IMKitApp"><div class="loader appLoader"></div></div>
    <!-- built files will be auto injected -->
    <script type="text/javascript" src="static/js/manifest.js"></script
    ><script type="text/javascript" src="static/js/vendor.js"></script
    ><script type="text/javascript" src="static/js/app.js"></script>
  </body>

  <script src="static/config.js"></script>
  <script>
    (() => {
      const IMKit = {};

      IMKit.Object = {
        fromEntries: entries =>
          [...entries].reduce(
            (object, [key, val]) => ({...object, [key]: val}),
            {},
          ),
      };

      IMKit.URL = {
        getParams: () =>
          IMKit.Object.fromEntries(new URLSearchParams(location.search))
      };

      // 處理 query string
      const { room, chatActionsPosition, token } = IMKit.URL.getParams();
      if (room) {
        config.defaultRoom = room;
      }
      if (chatActionsPosition) {
        config.chat.actionsPosition = chatActionsPosition;
      }
      if (token) {
        config.token = decodeURIComponent(token);
        localStorage.setItem("IMKit-token", decodeURIComponent(token));
      } else if (localStorage.getItem("IMKit-token")) {
        config.token = localStorage.getItem("IMKit-token");
      }

      // 沒有設定 client，導到登入
      if (!config.token) {
        if (document.location.href.indexOf("?")) {
          let queryString = document.location.href.split("?");
          queryString.shift();
          document.location.href = "demo?" + queryString.join("?");
        } else {
          document.location.href = "demo";
        }
      }

      // INIT
      window.ImkitJsSDK.init(config);
    })();
  </script>
</html>
